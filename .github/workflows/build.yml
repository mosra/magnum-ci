name: Angle

on: [push, pull_request]

env:
  # Bump this to fetch a newer version
  ANGLE_VERSION: 4134

jobs:
  windows:
    name: ${{ matrix.target }}
    runs-on: windows-latest
    strategy:
      matrix:
        target: ["windows", "windows-uwp"]
    env:
      # "If you are a non-googler you need to set DEPOT_TOOLS_WIN_TOOLCHAIN=0"
      DEPOT_TOOLS_WIN_TOOLCHAIN: 0
    steps:
    - uses: actions/checkout@v1
    - name: Clone
      run: |
        git clone --depth=1 --branch chromium/${{ env.ANGLE_VERSION }} https://chromium.googlesource.com/angle/angle
    - name: Set up Python 2.7
      uses: actions/setup-python@v1
      with:
        python-version: 2.7
    - name: Dependencies
      # https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#adding-a-system-path
      run: |
        Invoke-WebRequest https://storage.googleapis.com/chrome-infra/depot_tools.zip -O depot_tools.zip
        7z x depot_tools.zip -o${{ github.workspace }}/depot_tools
        echo "::add-path::${{ github.workspace }}\depot_tools"
    - name: Configure
      run: |
        mkdir angle\out
        mkdir angle\out\Release
        copy args-${{ matrix.target }}.gn angle\out\Release\args.gn
    - name: Generate
      run: |
        cd angle
        python scripts/bootstrap.py
        gclient.bat sync
        gn gen out/Release
    - name: Build
      run: |
        cd angle
        autoninja -C out/Release libEGL libGLESv2
    - name: Install
      run: |
        mkdir install
        mkdir install\lib
        mkdir install\bin
        mkdir install\include

        copy angle\out\Release\d3dcompiler_47.dll install\bin\
        copy angle\out\Release\libGLESv2.dll.lib install\lib\libGLESv2.lib
        copy angle\out\Release\libGLESv2.dll install\bin\
        copy angle\out\Release\libEGL.dll.lib install\lib\libEGL.lib
        copy angle\out\Release\libEGL.dll install\bin\
        xcopy /e angle\include\* install\include\
    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: angle-${{ env.ANGLE_VERSION }}-${{ matrix.target }}
        path: install

  mac:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-10.15]
    steps:
    - uses: actions/checkout@v1
    - name: Clone
      run: |
        git clone --depth=1 --branch chromium/${{ env.ANGLE_VERSION }} https://github.com/google/angle.git
    - name: Set up Python 2.7
      uses: actions/setup-python@v1
      with:
        python-version: 2.7
    - name: Dependencies
      # https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#adding-a-system-path
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "::add-path::${{ github.workspace }}/depot_tools"
    - name: Configure
      run: |
        mkdir angle/out
        mkdir angle/out/Release
        cp args-mac.gn angle/out/Release/args.gn
    - name: Generate
      run: |
        cd angle
        python scripts/bootstrap.py
        gclient sync
        gn gen out/Release
    - name: Build
      run: |
        cd angle
        autoninja -C out/Release libEGL libGLESv2
    - name: Install
      run: |
        mkdir install
        mkdir install/bin
        mkdir install/include

        cp angle/out/Release/libEGL.dylib install/bin/
        cp angle/out/Release/libGLESv2.dylib install/bin

        cp -R angle/include/* install/include/
    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: angle-${{ env.ANGLE_VERSION }}-${{ matrix.os }}
        path: install

  ubuntu:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-18.04]
    steps:
    - uses: actions/checkout@v1
    - name: Clone
      run: |
        git clone --depth=1 --branch chromium/${{ env.ANGLE_VERSION }} https://github.com/google/angle.git
    - name: Set up Python 2.7
      uses: actions/setup-python@v1
      with:
        python-version: 2.7
    - name: Dependencies
      # https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions#adding-a-system-path
      run: |
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
        echo "::add-path::${{ github.workspace }}/depot_tools"
    - name: Configure
      run: |
        mkdir angle/out
        mkdir angle/out/Release
        cp args-linux.gn angle/out/Release/args.gn
    - name: Generate
      run: |
        cd angle
        python scripts/bootstrap.py
        gclient sync
        gn gen out/Release
    - name: Build
      run: |
        cd angle
        autoninja -C out/Release libEGL libGLESv2
    - name: Install
      run: |
        mkdir install
        mkdir install/bin
        mkdir install/include
        cp angle/out/Release/libEGL.so install/bin/
        cp angle/out/Release/libGLESv2.so install/bin
        cp -R angle/include/* install/include/
    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: angle-${{ env.ANGLE_VERSION }}-${{ matrix.os }}
        path: install
